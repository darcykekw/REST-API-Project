<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; }
        .controls { display: flex; justify-content: space-between; margin-bottom: 20px; }
        input, button { padding: 10px; margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f8f9fa; }
        .btn { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; color: white; }
        .btn-primary { background-color: #007bff; }
        .btn-danger { background-color: #dc3545; }
        .btn-warning { background-color: #ffc107; color: black; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 400px; border-radius: 8px; }
        .close { float: right; cursor: pointer; font-size: 24px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Library Management System</h1>
        <div class="controls">
            <button class="btn btn-primary" onclick="showAddModal()">+ Add New Book</button>
            <div>
                <input type="text" id="searchInput" placeholder="Search by title or author...">
                <button class="btn btn-primary" onclick="searchBooks()">Search</button>
            </div>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold;">Current Token</label>
            <textarea id="tokenBox" readonly style="width: 100%; height: 70px;">Loading token...</textarea>
        </div>

        <table id="booksTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Year</th>
                    <th>ISBN</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Books will be loaded here -->
            </tbody>
        </table>
    </div>

    <!-- Add/Edit Modal -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add Book</h2>
            <input type="hidden" id="bookId">
            <label>Title:</label>
            <input type="text" id="bookTitle" style="width: 100%">
            <label>Author:</label>
            <input type="text" id="bookAuthor" style="width: 100%">
            <label>Published Year:</label>
            <input type="number" id="bookYear" style="width: 100%">
            <label>ISBN:</label>
            <input type="text" id="bookIsbn" style="width: 100%">
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="saveBook()">Save</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }

        // Show the token in the textarea so users can copy if needed
        const tokenBox = document.getElementById('tokenBox');
        if (tokenBox) {
            tokenBox.value = token;
        }

        async function fetchBooks(query = '') {
            let url = `/books?token=${token}`;
            if (query) url += `&q=${query}`;
            
            const response = await fetch(url);
            if (response.ok) {
                const books = await response.json();
                renderTable(books);
            } else {
                alert('Failed to fetch books. Session might be expired.');
                logout();
            }
        }

        function renderTable(books) {
            const tbody = document.querySelector('#booksTable tbody');
            tbody.innerHTML = '';
            books.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.published_year}</td>
                    <td>${book.isbn}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editBook(${book.id}, '${book.title}', '${book.author}', ${book.published_year}, '${book.isbn}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function saveBook() {
            const id = document.getElementById('bookId').value;
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const year = document.getElementById('bookYear').value;
            const isbn = document.getElementById('bookIsbn').value;

            const data = { title, author, published_year: year, isbn };
            let url = `/books?token=${token}`;
            let method = 'POST';

            if (id) {
                url = `/books/${id}?token=${token}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal();
                fetchBooks();
            } else {
                alert('Failed to save book');
            }
        }

        async function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                const response = await fetch(`/books/${id}?token=${token}`, { method: 'DELETE' });
                if (response.ok) fetchBooks();
                else alert('Failed to delete book');
            }
        }

        function searchBooks() {
            const query = document.getElementById('searchInput').value;
            fetchBooks(query);
        }

        function showAddModal() {
            document.getElementById('modalTitle').innerText = 'Add Book';
            document.getElementById('bookId').value = '';
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookYear').value = '';
            document.getElementById('bookIsbn').value = '';
            document.getElementById('bookModal').style.display = 'block';
        }

        function editBook(id, title, author, year, isbn) {
            document.getElementById('modalTitle').innerText = 'Edit Book';
            document.getElementById('bookId').value = id;
            document.getElementById('bookTitle').value = title;
            document.getElementById('bookAuthor').value = author;
            document.getElementById('bookYear').value = year;
            document.getElementById('bookIsbn').value = isbn;
            document.getElementById('bookModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('bookModal').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Initial load
        fetchBooks();
    </script>
</body>
</html>